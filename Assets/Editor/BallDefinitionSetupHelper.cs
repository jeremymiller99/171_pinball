#if UNITY_EDITOR
using System.Collections.Generic;
using System.IO;
using UnityEditor;
using UnityEditor.SceneManagement;
using UnityEngine;

// Generated by Cursor AI (GPT-5.2) for jjmil on 2026-02-16.

/// <summary>
/// Editor helper to create BallDefinition assets and link them to ball prefabs.
/// Access via menu: Tools > Balls > Create Definitions + Link Prefabs
/// </summary>
public static class BallDefinitionSetupHelper
{
    private const string BallPrefabsPath = "Assets/Prefabs/Balls/";
    private const string BallDefinitionsPath = "Assets/Scripts/BallDefinitions/";
    private const string ShopPanelPrefabPath = "Assets/Prefabs/UI/Shop Panel.prefab";

    [MenuItem("Tools/Balls/Create Definitions + Link Prefabs")]
    public static void CreateDefinitionsAndLinkPrefabs()
    {
        EnsureDirectoryExists(BallDefinitionsPath);

        string[] prefabGuids = AssetDatabase.FindAssets("t:Prefab", new[] { BallPrefabsPath });
        if (prefabGuids == null || prefabGuids.Length == 0)
        {
            Debug.LogWarning($"No prefabs found under {BallPrefabsPath}");
            return;
        }

        int created = 0;
        int updated = 0;
        int linked = 0;

        for (int i = 0; i < prefabGuids.Length; i++)
        {
            string prefabPath = AssetDatabase.GUIDToAssetPath(prefabGuids[i]);
            GameObject prefab = AssetDatabase.LoadAssetAtPath<GameObject>(prefabPath);
            if (prefab == null)
            {
                continue;
            }

            string assetName = SanitizeAssetFileName(prefab.name);
            string defPath = $"{BallDefinitionsPath}{assetName}.asset";

            var def = AssetDatabase.LoadAssetAtPath<BallDefinition>(defPath);
            if (def == null)
            {
                def = ScriptableObject.CreateInstance<BallDefinition>();
                SetDefinitionDefaults(def, prefab);
                AssetDatabase.CreateAsset(def, defPath);
                created++;
            }
            else
            {
                bool changed = EnsureDefinitionReferencesPrefab(def, prefab);
                if (changed)
                {
                    updated++;
                }
            }

            bool didLink = EnsurePrefabHasLink(prefabPath, def);
            if (didLink)
            {
                linked++;
            }
        }

        AssetDatabase.SaveAssets();
        AssetDatabase.Refresh();

        Debug.Log(
            $"Ball definitions: created={created}, updated={updated}, linkedPrefabs={linked}. " +
            $"Definitions path: {BallDefinitionsPath}");
    }

    [MenuItem("Tools/Balls/Assign Catalog To Shop Panel Prefab")]
    public static void AssignCatalogToShopPanelPrefab()
    {
        List<BallDefinition> defs = LoadAllBallDefinitions();
        if (defs.Count == 0)
        {
            Debug.LogWarning($"No BallDefinition assets found under {BallDefinitionsPath}");
            return;
        }

        GameObject root = PrefabUtility.LoadPrefabContents(ShopPanelPrefabPath);
        if (root == null)
        {
            Debug.LogError($"Could not load prefab: {ShopPanelPrefabPath}");
            return;
        }

        ShopUIController shop = root.GetComponentInChildren<ShopUIController>(includeInactive: true);
        if (shop == null)
        {
            PrefabUtility.UnloadPrefabContents(root);
            Debug.LogWarning($"No {nameof(ShopUIController)} found in {ShopPanelPrefabPath}");
            return;
        }

        var so = new SerializedObject(shop);
        var listProp = so.FindProperty("allBallDefinitions");
        listProp.arraySize = 0;
        listProp.arraySize = defs.Count;
        for (int i = 0; i < defs.Count; i++)
        {
            listProp.GetArrayElementAtIndex(i).objectReferenceValue = defs[i];
        }

        so.ApplyModifiedPropertiesWithoutUndo();
        PrefabUtility.SaveAsPrefabAsset(root, ShopPanelPrefabPath);
        PrefabUtility.UnloadPrefabContents(root);

        Debug.Log($"Assigned {defs.Count} ball definitions to {ShopPanelPrefabPath}");
    }

    [MenuItem("Tools/Balls/Convert Starting Loadout Prefabs To Definitions (Open Scenes)")]
    public static void ConvertStartingLoadoutPrefabsToDefinitions()
    {
        GameRulesManager[] managers =
            Object.FindObjectsByType<GameRulesManager>(FindObjectsSortMode.None);
        if (managers == null || managers.Length == 0)
        {
            Debug.LogWarning($"No {nameof(GameRulesManager)} found in open scenes.");
            return;
        }

        int updated = 0;
        for (int m = 0; m < managers.Length; m++)
        {
            if (managers[m] == null)
            {
                continue;
            }

            var so = new SerializedObject(managers[m]);
            var legacy = so.FindProperty("startingBallLoadout");
            var defsProp = so.FindProperty("startingBallLoadoutDefinitions");

            var defs = new List<BallDefinition>();
            for (int i = 0; i < legacy.arraySize; i++)
            {
                var prefab =
                    legacy.GetArrayElementAtIndex(i).objectReferenceValue as GameObject;
                if (prefab == null)
                {
                    continue;
                }

                BallDefinition def = BallDefinitionUtilities.TryGetDefinitionFromPrefab(prefab);
                if (def != null)
                {
                    defs.Add(def);
                }
            }

            defsProp.arraySize = 0;
            defsProp.arraySize = defs.Count;
            for (int i = 0; i < defs.Count; i++)
            {
                defsProp.GetArrayElementAtIndex(i).objectReferenceValue = defs[i];
            }

            so.ApplyModifiedPropertiesWithoutUndo();
            EditorUtility.SetDirty(managers[m]);
            updated++;
        }

        if (updated > 0)
        {
            EditorSceneManager.MarkAllScenesDirty();
        }

        Debug.Log($"Converted starting loadouts for {updated} {nameof(GameRulesManager)}.");
    }

    private static void SetDefinitionDefaults(BallDefinition def, GameObject prefab)
    {
        if (def == null)
        {
            return;
        }

        var so = new SerializedObject(def);
        so.FindProperty("id").stringValue = prefab != null ? prefab.name : "";
        so.FindProperty("displayName").stringValue = prefab != null ? prefab.name : "Ball";
        so.FindProperty("description").stringValue = "";
        so.FindProperty("rarity").enumValueIndex = (int)BallRarity.Common;
        so.FindProperty("icon").objectReferenceValue =
            BallDefinitionUtilities.TryGetPrefabSpriteIcon(prefab);
        so.FindProperty("prefab").objectReferenceValue = prefab;
        so.FindProperty("price").intValue = 10;
        so.ApplyModifiedPropertiesWithoutUndo();

        EditorUtility.SetDirty(def);
    }

    private static bool EnsureDefinitionReferencesPrefab(BallDefinition def, GameObject prefab)
    {
        if (def == null)
        {
            return false;
        }

        bool changed = false;
        var so = new SerializedObject(def);

        var prefabProp = so.FindProperty("prefab");
        if (prefabProp.objectReferenceValue == null && prefab != null)
        {
            prefabProp.objectReferenceValue = prefab;
            changed = true;
        }

        var iconProp = so.FindProperty("icon");
        if (iconProp.objectReferenceValue == null)
        {
            Sprite sprite = BallDefinitionUtilities.TryGetPrefabSpriteIcon(prefab);
            if (sprite != null)
            {
                iconProp.objectReferenceValue = sprite;
                changed = true;
            }
        }

        if (changed)
        {
            so.ApplyModifiedPropertiesWithoutUndo();
            EditorUtility.SetDirty(def);
        }

        return changed;
    }

    private static bool EnsurePrefabHasLink(string prefabPath, BallDefinition def)
    {
        if (string.IsNullOrWhiteSpace(prefabPath) || def == null)
        {
            return false;
        }

        GameObject root = PrefabUtility.LoadPrefabContents(prefabPath);
        if (root == null)
        {
            return false;
        }

        bool changed = false;

        BallDefinitionLink link = root.GetComponent<BallDefinitionLink>();
        if (link == null)
        {
            link = root.AddComponent<BallDefinitionLink>();
            changed = true;
        }

        var so = new SerializedObject(link);
        var defProp = so.FindProperty("definition");
        if (defProp.objectReferenceValue != def)
        {
            defProp.objectReferenceValue = def;
            changed = true;
        }

        if (changed)
        {
            so.ApplyModifiedPropertiesWithoutUndo();
            PrefabUtility.SaveAsPrefabAsset(root, prefabPath);
        }

        PrefabUtility.UnloadPrefabContents(root);
        return changed;
    }

    private static void EnsureDirectoryExists(string assetPathWithTrailingSlash)
    {
        if (!AssetDatabase.IsValidFolder(assetPathWithTrailingSlash.TrimEnd('/')))
        {
            string parent = Path.GetDirectoryName(assetPathWithTrailingSlash.TrimEnd('/'));
            string folderName = Path.GetFileName(assetPathWithTrailingSlash.TrimEnd('/'));

            if (!string.IsNullOrEmpty(parent) && !string.IsNullOrEmpty(folderName))
            {
                if (!AssetDatabase.IsValidFolder(parent))
                {
                    EnsureDirectoryExists(parent + "/");
                }
                AssetDatabase.CreateFolder(parent, folderName);
            }
        }
    }

    private static string SanitizeAssetFileName(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
        {
            return "Ball";
        }

        foreach (char c in Path.GetInvalidFileNameChars())
        {
            name = name.Replace(c.ToString(), "_");
        }

        return name.Replace(" ", "_");
    }

    private static List<BallDefinition> LoadAllBallDefinitions()
    {
        var results = new List<BallDefinition>();

        string[] guids = AssetDatabase.FindAssets(
            "t:BallDefinition",
            new[] { BallDefinitionsPath });

        if (guids == null || guids.Length == 0)
        {
            return results;
        }

        for (int i = 0; i < guids.Length; i++)
        {
            string path = AssetDatabase.GUIDToAssetPath(guids[i]);
            var def = AssetDatabase.LoadAssetAtPath<BallDefinition>(path);
            if (def != null)
            {
                results.Add(def);
            }
        }

        return results;
    }
}
#endif

